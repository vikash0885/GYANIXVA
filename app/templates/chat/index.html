{% extends "base.html" %}

{% block content %}
<div class="row g-0 h-100 min-vh-75">
    <!-- Sidebar -->
    <div class="col-md-4 col-lg-3 border-end border-secondary bg-dark bg-opacity-25 d-none d-md-flex flex-column"
        style="border-right: 1px solid rgba(255,255,255,0.1);">
        <div class="p-3 border-bottom border-secondary">
            <a href="{{ url_for('chat.index') }}" class="btn btn-primary w-100"><i class="bi bi-plus-lg me-2"></i> New
                Chat</a>
        </div>
        <div class="flex-grow-1 overflow-auto p-2">
            <div class="list-group list-group-flush chat-history-list">
                {% for chat in recent_chats %}
                <div
                    class="list-group-item bg-transparent text-secondary border-0 p-2 d-flex justify-content-between align-items-center group-hover-container {{ 'active-chat' if active_session and active_session.id == chat.id else '' }}">
                    <a href="{{ url_for('chat.session', session_id=chat.id) }}"
                        class="text-decoration-none text-reset text-truncate w-100">
                        <i class="bi bi-chat-left me-2"></i> {{ chat.title }}
                    </a>
                    <button onclick="deleteChat({{ chat.id }})"
                        class="btn btn-sm text-danger opacity-0 group-hover-show"><i class="bi bi-trash"></i></button>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="col-md-8 col-lg-9 d-flex flex-column h-100" style="min-height: 75vh;">
        <div class="flex-grow-1 p-4 overflow-auto" id="chat-messages">
            {% if active_session %}
            {% for msg in active_session.messages %}
            <div class="d-flex mb-4 {{ 'justify-content-end' if msg.role == 'user' else '' }}">
                <div class="p-3 rounded-4 {{ 'bg-primary text-white' if msg.role == 'user' else 'bg-secondary bg-opacity-25 text-light message-content' }}"
                    style="max-width: 75%;">
                    {{ msg.content if msg.role == 'user' else '' }}
                    {% if msg.role == 'ai' %}
                    <!-- Content will be parsed by JS on load -->
                    {{ msg.content }}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center mt-5 pt-5">
                <div class="display-1 text-secondary opacity-25 mb-3"><i class="bi bi-robot"></i></div>
                <h3>How can I help you learn today?</h3>
                <p class="text-secondary">Ask me about Physics, Math, History, or help planning your studies.</p>
            </div>
            {% endif %}
            <div id="typing-indicator" class="d-none text-secondary ms-2 mb-4">
                <small>AI is typing...</small>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 border-top border-secondary bg-dark bg-opacity-50">
            <form id="chat-form" class="d-flex gap-2">
                <input type="hidden" id="session_id" value="{{ active_session.id if active_session else '' }}">
                <input type="text" id="user-input" class="form-control" placeholder="Ask a doubt..." required
                    autocomplete="off">
                <button type="submit" class="btn btn-primary"><i class="bi bi-send-fill"></i></button>
            </form>
        </div>
    </div>
</div>

<script>
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.scrollTop = chatMessages.scrollHeight;

    document.getElementById('chat-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('user-input');
        const sessionIdInput = document.getElementById('session_id');
        const message = input.value.trim();

        if (!message) return;

        // Add user message to UI
        appendMessage('user', message);
        input.value = '';

        // Show typing indicator
        const typingIndicator = document.getElementById('typing-indicator');
        typingIndicator.classList.remove('d-none');
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
            const response = await fetch('/api/chat/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    session_id: sessionIdInput.value || null
                })
            });

            const data = await response.json();

            // Hide typing indicator
            typingIndicator.classList.add('d-none');

            if (data.error) {
                alert(data.error);
                return;
            }

            // Update session ID if new
            if (!sessionIdInput.value && data.session_id) {
                sessionIdInput.value = data.session_id;
                // Ideally, we'd update the URL here without reload, 
                // but for simplicity, we'll reload only if it was a new chat to show in sidebar
                window.history.pushState({}, '', `/chat/${data.session_id}`);
                // Refresh to update sidebar (optional, could be done via JS DOM manipulation)
                setTimeout(() => location.reload(), 1000);
            } else {
                appendMessage('ai', data.ai_message.content);
            }

        } catch (error) {
            console.error('Error:', error);
            typingIndicator.classList.add('d-none');
        }
    });

    function appendMessage(role, content) {
        const div = document.createElement('div');
        div.className = `d-flex mb-4 ${role === 'user' ? 'justify-content-end' : ''}`;
        div.innerHTML = `
            <div class="p-3 rounded-4 ${role === 'user' ? 'bg-primary text-white' : 'bg-secondary bg-opacity-25 text-light message-content'}" style="max-width: 75%;">
                ${role === 'ai' ? marked.parse(content) : content}
            </div>
        `;
        // Insert before typing indicator
        const typingIndicator = document.getElementById('typing-indicator');
        chatMessages.insertBefore(div, typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function deleteChat(id) {
        if (!confirm('Are you sure you want to delete this chat?')) return;

        try {
            await fetch(`/chat/delete/${id}`, { method: 'POST' });
            location.href = "{{ url_for('chat.index') }}";
        } catch (e) {
            console.error(e);
        }
    }
</script>

<style>
    .group-hover-container:hover .group-hover-show {
        opacity: 1 !important;
    }

    .active-chat {
        background: rgba(99, 102, 241, 0.1) !important;
        border-left: 3px solid var(--accent-color) !important;
    }
</style>
{% endblock %}